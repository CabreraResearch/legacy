<!--#include file="MainHeader.html" -->
<script language="javascript">

    function login() {

        var div = Csw.literals.factory($('#div1'));
        clearerror();

        function cleardiv() {
            div.$.contents().remove();
            clearerror();
        }

        $.CswLogin({
            AccessId: $('#accessid').val(),
            UserName: $('#username').val(),
            Password: $('#password').val(),
            onAuthenticate: function () {

                var to = null;
                cleardiv();

                var outertable = div.table({
                    ID: 'outertable'
                });

                var cell11 = outertable.cell(1, 1);
                var cell12 = outertable.cell(1, 2);

                cell11.span({ text: 'Test Delay (ms):' });
                cell11.append('<br/>');
                var delaytb = cell11.input({ ID: 'delay', value: '500' });
                cell11.append('<br/>');
                cell11.append('<br/>');

                cell11.span({ text: 'Please select a View to test:' });
                var vs = cell11.viewSelect({
                    onSelect: function (itemobj) {
                        if (itemobj.type.toLowerCase() != 'view') {
                            error('Please select a View (not a Report or Action)');
                            startBtn.disable();
                        }
                        else {
                            startBtn.enable();
                        }
                    }
                });

                var startBtn = cell11.button({
                    ID: 'start',
                    enabledText: 'Start',
                    disableOnClick: false,
                    onClick: function () {
                        test();
                    }
                });
                startBtn.disable();

                var stopBtn = cell11.button({
                    ID: 'stop',
                    enabledText: 'Stop',
                    disableOnClick: false,
                    onClick: function () {
                        if (to !== null) {
                            clearTimeout(to);
                        }
                        startBtn.enable();
                        stopBtn.disable();
                    }
                });
                stopBtn.disable();

                var tbl = cell12.table({
                    ID: 'resultstbl',
                    cellpadding: '5px'
                });

                var row = 1;

                // Header row
                tbl.cell(row, 1).append('<b>View</b>');
                tbl.cell(row, 2).append('<b>Client Start</b>');
                tbl.cell(row, 3).append('<b>Client End</b>');
                tbl.cell(row, 4).append('<b>Client Total</b>');
                tbl.cell(row, 5).append('<b>Server Init</b>');
                tbl.cell(row, 6).append('<b>Server Total</b>');
                tbl.cell(row, 7).append('<b>DB Init</b>');
                tbl.cell(row, 8).append('<b>DB Query</b>');
                tbl.cell(row, 9).append('<b>DB Commit</b>');
                tbl.cell(row, 10).append('<b>DB DeInit</b>');
                tbl.cell(row, 11).append('<b>DB Tree Loader</b>');
                row++;

                function test() {
                    var starttime = new Date();
                    startBtn.disable();
                    stopBtn.enable();

                    Csw.ajax.post({
                        url: '/NbtWebApp/wsNBT.asmx/runTree',
                        data: {
                            ViewId: vs.value().value,
                            IdPrefix: 'test',
                            IncludeNodeRequired: false,
                            IncludeNodeKey: '',
                            IncludeNodeId: '',
                            NodePk: '',
                            IncludeInQuickLaunch: false,
                            DefaultSelect: ''
                        },
                        stringify: false,
                        removeTimer: false,
                        success: function (result) {
                            var endtime = new Date();

                            tbl.cell(row, 1).append(vs.value().name);
                            var stms = Csw.string(starttime.getMilliseconds());
                            while (stms.length < 3) {
                                stms = "0" + stms;
                            }
                            tbl.cell(row, 2).append(starttime.toLocaleTimeString() + "." + stms);
                            var etms = Csw.string(endtime.getMilliseconds());
                            while (etms.length < 3) {
                                etms = "0" + etms;
                            }
                            tbl.cell(row, 3).append(endtime.toLocaleTimeString() + "." + etms);
                            tbl.cell(row, 4).append(Csw.number(endtime - starttime));
                            tbl.cell(row, 5).append(result.timer.serverinit);
                            tbl.cell(row, 6).append(result.timer.servertotal);
                            tbl.cell(row, 7).append(result.timer.dbinit);
                            tbl.cell(row, 8).append(result.timer.dbquery);
                            tbl.cell(row, 9).append(result.timer.dbcommit);
                            tbl.cell(row, 10).append(result.timer.dbdeinit);
                            tbl.cell(row, 11).append(result.timer.treeloadersql);
                            row++;

                            to = setTimeout(test, Csw.number(delaytb.val(), 500));
                        } // success
                    }); // ajax.post()
                }

            }, // onAuthenticate
            onFail: function (msg) {
                error(msg);
            } // onFail
        }); // CswLogin
    } // login()

    function error(msg) {
        $('#ErrorDiv').text(msg)
            .show();
    }
    function clearerror() {
        $('#ErrorDiv').hide();
    }

</script>
<tr>
    <td id="Td5" class="PageTable_LeftColumn">
        <img src="Images/pagelayout/blank.gif" alt="X" width="1" height="450" />
    </td>
    <td id="HeaderTable_BottomMenu" class="HeaderTable_BottomMenu" colspan="2" valign="top">
        <div id="div1">
            <h1>
                NBT Performance Test
            </h1>
            <table>
                <tr>
                    <td>
                        Accessid:
                    </td>
                    <td>
                        <input type="text" id="accessid" value="1" size="8" />
                    </td>
                </tr>
                <tr>
                    <td>
                        User:
                    </td>
                    <td>
                        <input type="text" id="username" value="admin" />
                    </td>
                </tr>
                <tr>
                    <td>
                        Password:
                    </td>
                    <td>
                        <input type="password" id="password" value="admin" />
                    </td>
                </tr>
                <tr>
                    <td>
                        &nbsp;
                    </td>
                    <td>
                        <input type="button" id="loginbtn" value="Login" onclick="login();" />
                    </td>
                </tr>
            </table>
        </div>
        <div id="ErrorDiv" class="error" style="display: none;">
        </div>
    </td>
    <td id="Td6" class="PageTable_RightColumn">
    </td>
</tr>
<!--#include file="MainFooter.html" -->
