<!--#include file="MainHeader.html" -->
<script type="text/javascript">


var began = new Date();


function showTestOutput($table, lineno, action, status,started,ended) {
    var now = new Date();

    var $tr = $('<tr></tr>').appendTo($table);
    $tr.append('<td>' + ((now.getTime() - began.getTime()) / 1000) + '</td>');
    if (started !== undefined && ended !== undefined) {
        $tr.append('<td>' + ((ended.getTime() - started.getTime()) / 1000) + '</td>');
    }
    else {
        $tr.append('<td>&nbsp;</td>');
    }
    $tr.append('<td>' + lineno + '</td>');
    $tr.append('<td>' + action + '</td>');
    $tr.append('<td>' + status + '</td>');
}

function _execAction($table,testno, actname, actdata, nextfunc) {
    var status = '?';
    var ajaxStartTime = new Date();

    Csw.ajax.post({
        'url': 'wsNBT.asmx/' + actname,
        'data': actdata,
        showAuth: true,
        success: function (outputdata)
        {
            var ajaxEndTime = new Date();
            status = 'succeeded';
 
            showTestOutput($table, testno, actname, status, ajaxStartTime, ajaxEndTime);
            Csw.tryExec(nextfunc);
        },
        error: function (outputdata)
        {
            outputdata = outputdata || {};
            showTestOutput($table, testno, actname, 'ERROR ' + outputdata.message);
            Csw.tryExec(nextfunc);
        }
    });

}

function test_getQuickLaunchItems($table,testno,nextfunc) {
    _execAction($table,testno, 'getQuickLaunchItems', { "UserId": "" }, 
         nextfunc);
}

function test_getMainMenu($table, testno, nextfunc) {
    _execAction($table, testno, 'getMainMenu', { "ViewId": "", "SafeNodeKey": "", "PropIdAttr": "", "LimitMenuTo": "" },
         nextfunc);
}

function test_getLandingPageItems($table, testno, nextfunc) {
    _execAction($table, testno, 'getLandingPageItems', { "RoleId": "" },
         nextfunc);
}

function test_getViewTree($table, testno, nextfunc) {
    _execAction($table, testno, 'getViewTree', { "IsSearchable": "false", "UseSession": "true" }, 
         nextfunc);
}

function test_getHeaderMenu($table, testno, nextfunc) {
    _execAction($table, testno, 'getHeaderMenu', {}, 
         nextfunc);
}

function test_getHeaderMenu($table, testno, nextfunc) {
    _execAction($table, testno, 'getHeaderMenu', {}, 
         nextfunc);
}

function test_getDashboard($table, testno, nextfunc) {
    _execAction($table, testno, 'getDashboard', {}, 
         nextfunc);
}

function test_getTreeOfViewInit($table, testno, nextfunc) {
    _execAction($table, testno, 'getTreeOfView', { "UsePaging": true, "ViewId": "ViewId_176", "IdPrefix": "main_", "IsFirstLoad": true, "ParentNodeKey": "", "IncludeNodeRequired": false, "IncludeNodeKey": "", "ShowEmpty": false, "ForSearch": false, "NodePk": "", "IncludeInQuickLaunch": true },
         nextfunc);
}

function test_getTabsForEquipNode($table, testno, nextfunc) { //22983
    _execAction($table, testno, 'getTabs', { "EditMode": "Edit", "NodeId": "nodes_X2983", "SafeNodeKey": "\"/NbtTree/NbtNode/NbtNode[@tablename=\\u0027nodes\\u0027 and  @nodeid=22983]:nodes_22983:Plain:6:146:ViewId_176:8:0/1\"", "NodeTypeId": "", "Date": "", "filterToPropId": "", "Multi": false },
        nextfunc);
}

function _beginTests(accessid,username,password) {

    var $table = $('<table border="1" width="100%"/>').appendTo($('#div1'));
    $table.append('<tr><td>Elapsed (sec)</td><td>Ajax Time (sec)</td><td>Test#</td><td>ServiceName</td><td>Status</td></tr>');

    var ajaxstart = new Date();
    var ajaxend;

    Csw.ajax.post({
        'url': 'wsNBT.asmx/authenticate',
        'data': { "AccessId": accessid, "UserName": username, "Password": password, "ForMobile": "false" },
        showAuth: true,
        success: function (outputdata)
        {
            var status = 'succeeded';
            ajaxend = new Date();
            showTestOutput($table, 'BEGIN', 'authenticate', status + ' BEGAN ' + began.toString(), ajaxstart, ajaxend);

            test_getDashboard($table, 1, function ()
            {
                test_getHeaderMenu($table, 2, function ()
                {
                    test_getViewTree($table, 3, function ()
                    {
                        test_getLandingPageItems($table, 4, function ()
                        {
                            test_getMainMenu($table, 5, function ()
                            {
                                test_getQuickLaunchItems($table, 6, function ()
                                {
                                    test_getTreeOfViewInit($table, 7, function ()
                                    {
                                        test_getTabsForEquipNode($table, 8, function ()
                                        {
                                            _endTests($table, 'Ended OK');
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        },
        error: function (data)
        {
            showTestOutput($table, 'BEGIN', 'authenticate', 'ERROR failed web service call');
            _endTests($table, 'Ended with errors.');
        }
    });

}

function _endTests($table,errorstr) {

    var ajaxStart = new Date();
    var ajaxEnd;
    //deauthenticate or bust
    Csw.ajax.post({
        'url': 'wsNBT.asmx/deauthenticate',
        'data': {},
        success: function (outputdata) {
            ajaxEnd = new Date();
            showTestOutput($table, 'END', 'deauthenticate', 'succeeded ' + errorstr, ajaxStart, ajaxEnd);
        },
        error: function () {
            ajaxEnd = new Date();
            showTestOutput($table, 'END', 'deauthenticate', 'ERROR failed web service call', ajaxStart, ajaxEnd);
        }
    });

}



</script>


<div id="div1"><h1>wsNBT Test Harness v0.1</h1>
Accessid:<input type="text" id="accessid" value="nbt_manager" size="6" />
 User:<input type="text" id="username" value="chemsw_admin" />
 Password:<input type="password" id="password" value="chemsw123" />
<input type="button" id="run" value="Run Tests" onclick="_beginTests($('#accessid').val(),$('#username').val(),$('#password').val());" />

<!--#include file="MainFooter.html" -->
