<!--#include file="MainIncludes.html" -->

<html>
<head>

<script type="text/javascript">

debugOn(debug);

var began = new Date();


function showTestOutput($table, lineno, action, status, msg,started,ended) {
    var now = new Date();

    var $tr = $('<tr></tr>').appendTo($table);
    $tr.append('<td>' + ((now.getTime() - began.getTime()) / 1000) + '</td>');
    if (started !== undefined && ended !== undefined) {
        $tr.append('<td>' + ((ended.getTime() - started.getTime()) / 1000) + '</td>');
    }
    else {
        $tr.append('<td>&nbsp;</td>');
    }
    $tr.append('<td>' + lineno + '</td>');
    $tr.append('<td>' + action + '</td>');
    $tr.append('<td>' + status + '</td>');
    $tr.append('<td>' + msg + '</td>');
}

function _execAction($table,testno, actname, actdata, resname, valStrIn, nextfunc) {
    var status = '?';
    var propval = '';
    var ajaxStartTime = new Date();

    Csw.ajax.post({
        'url': '/NbtWebApp/wsNBT.asmx/' + actname,
        'data': actdata,
        showAuth: true,
        success: function (outputdata) {
            var ajaxEndTime = new Date();


            var objHelper = new ObjectHelper(outputdata);
            if (resname !== '' && valStrIn !== '') {
                if (false !== objHelper.find(resname, valStrIn)) {
                    status = 'succeeded';
                    propval = ' result=' + objHelper.find(resname, valStrIn)[resname];
                }
                else {
                    status = 'FAILED';
                }
            }
            else {
                status = 'not_validated';
                propval = outputdata;
            }

            showTestOutput($table, testno, actname, status, propval, ajaxStartTime, ajaxEndTime);
            Csw.tryExec(nextfunc);
        },
        error: function (outputdata) {
            log(outputdata.message);
            showTestOutput($table, testno, actname, 'ERROR', outputdata.message);
            Csw.tryExec(nextfunc);
        }
    });

}

function test_getQuickLaunchItems($table,testno,nextfunc) {
    _execAction($table,testno, 'getQuickLaunchItems', { "UserId": "" }, 'AuthenticationStatus', 'Authenticated',
         nextfunc);
}

function test_getMainMenu($table, testno, nextfunc) {
    _execAction($table, testno, 'getMainMenu', { "ViewId": "", "SafeNodeKey": "", "PropIdAttr": "" }, 'action', 'GenericSearch',
         nextfunc);
}

function test_getWelcomeItems($table, testno, nextfunc) { 
    _execAction($table, testno, 'getWelcomeItems', { "RoleId": "" }, 'viewmode', 'list',
         nextfunc);
}

function test_getViewTree($table, testno, nextfunc) {
    _execAction($table, testno, 'getViewTree', { "IsSearchable": "false", "UseSession": "true" }, 'data', 'Equipment',
         nextfunc);
}

function test_getHeaderMenu($table, testno, nextfunc) {
    _execAction($table, testno, 'getHeaderMenu', {}, 'action', 'Home',
         nextfunc);
}

function test_getHeaderMenu($table, testno, nextfunc) {
    _execAction($table, testno, 'getHeaderMenu', {}, 'action', 'Home',
         nextfunc);
}

function test_getDashboard($table, testno, nextfunc) {
    _execAction($table, testno, 'getDashboard', {}, 'text', 'IMCS - Instrument Maintenance and Calibration',
         nextfunc);
}

function test_getTreeOfViewInit($table, testno, nextfunc) {
    _execAction($table, testno, 'getTreeOfView', { "UsePaging": true, "ViewId": "ViewId_176", "IdPrefix": "main_", "IsFirstLoad": true, "ParentNodeKey": "", "IncludeNodeRequired": false, "IncludeNodeKey": "", "ShowEmpty": false, "ForSearch": false, "NodePk": "", "IncludeInQuickLaunch": true },
     'data', 'All Equipment',
         nextfunc);
}

function test_getTabsForEquipNode($table, testno, nextfunc) { //22983
    _execAction($table, testno, 'getTabs', { "EditMode": "Edit", "NodeId": "nodes_X2983", "SafeNodeKey": "\"/NbtTree/NbtNode/NbtNode[@tablename=\\u0027nodes\\u0027 and  @nodeid=22983]:nodes_22983:Plain:6:146:ViewId_176:8:0/1\"", "NodeTypeId": "", "Date": "", "filterToPropId": "", "Multi": false },
     'name', 'Equipment Type',
         nextfunc);
}

function _beginTests(accessid,username,password) {

    var $table = $('<table border="1" width="100%"/>').appendTo($('#div1'));
    $table.append('<tr><td>Elapsed (sec)</td><td>Ajax Time (sec)</td><td>Test#</td><td>ServiceName</td><td>Status</td><td>Details</td></tr>');

    var ajaxstart = new Date();
    var ajaxend;

    Csw.ajax.post({
        'url': '/NbtWebApp/wsNBT.asmx/authenticate',
        'data': { "AccessId": accessid, "UserName": username, "Password": password, "ForMobile": "false" },
        showAuth: true,
        success: function (outputdata) {
            var status = 'failed';
            if (outputdata['AuthenticationStatus'].toString().indexOf('Authenticated') > -1) {
                status = 'succeeded';
            }
            ajaxend = new Date();
            showTestOutput($table, 'BEGIN', 'authenticate', status, began.toString(), ajaxstart, ajaxend);

            test_getDashboard($table, 1, function () {
                test_getHeaderMenu($table, 2, function () {
                    test_getViewTree($table, 3, function () {
                        test_getWelcomeItems($table, 4, function () {
                            test_getMainMenu($table, 5, function () {
                                test_getQuickLaunchItems($table, 6, function () {
                                    test_getTreeOfViewInit($table, 7, function () {
                                        test_getTabsForEquipNode($table, 8, function () {
                                            _endTests($table, 'Ended OK');
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        },
        error: function (data) {
            showTestOutput($table, 'BEGIN', 'authenticate', 'ERROR', 'failed web service call');
            _endTests($table, 'Ended with errors.');
        }
    });

}

function _endTests($table,errorstr) {

    var ajaxStart = new Date();
    var ajaxEnd;
    //deauthenticate or bust
    Csw.ajax.post({
        'url': '/NbtWebApp/wsNBT.asmx/deauthenticate',
        'data': {},
        success: function (outputdata) {
            ajaxEnd = new Date();
            showTestOutput($table, 'END', 'deauthenticate', 'succeeded', errorstr, ajaxStart, ajaxEnd);
        },
        error: function () {
            ajaxEnd = new Date();
            showTestOutput($table, 'END', 'deauthenticate', 'ERROR', 'failed web service call', ajaxStart, ajaxEnd);
        }
    });

}

function _noAuthTests() {

    var $table = $('<table border="1" width="100%"/>').appendTo($('#div1'));
    $table.append('<tr><td>Elapsed (sec)</td><td>Ajax Time (sec)</td><td>Test#</td><td>ServiceName</td><td>Status</td><td>Details</td></tr>');

    var ajaxstart = new Date();
    var ajaxend;

    Csw.ajax.post({
        'url': '/NbtWebApp/wsNBT.asmx/authenticate',
        'data': { "AccessId": 1, "UserName": 'bogus', "Password": 'junk876$', "ForMobile": "false" },
        showAuth: true,
        success: function (outputdata) {
            var status = 'failed';
            if (outputdata['AuthenticationStatus'].toString().indexOf('Authenticated') > -1) {
                status = 'succeeded';
            }
            ajaxend = new Date();
            showTestOutput($table, 'BEGIN', 'authenticate', status, began.toString(), ajaxstart, ajaxend);

        },
        error: function (data) {
            showTestOutput($table, 'BEGIN', 'authenticate', 'ERROR', 'failed web service call');
        }
    });

    test_getDashboard($table, 1); 
    test_getHeaderMenu($table, 2); 
    test_getViewTree($table, 3); 
    test_getWelcomeItems($table, 4);
    test_getMainMenu($table, 5); 
    test_getQuickLaunchItems($table, 6); 
    test_getTreeOfViewInit($table, 7); 
    test_getTabsForEquipNode($table, 8); 
    _endTests($table, 'Ended OK');

}


$(document).ready(function () {


});


</script>


</head>
<body>
<div id="div1"><h1>wsNBT Test Harness v0.1</h1>
Accessid:<input type="text" id="accessid" value="1" size="6" />
 User:<input type="text" id="username" value="chemsw_admin" />
 Password:<input type="password" id="password" value="chemsw123" />
<input type="button" id="run" value="Run Tests" onclick="_beginTests($('#accessid').val(),$('#username').val(),$('#password').val());" />
<input type="button" id="noauth" value="Run NO_AUTH Tests" onclick="_noAuthTests();" /></div>
</body>
</html>
