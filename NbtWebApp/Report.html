<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <link rel="shortcut icon" href="images/favicon.ico" />
    <title>ChemSW Live</title>
    <!--#include file="MainIncludes.html" -->
    <script type="text/javascript" src="js/ChemSW.min.js"></script> 
    <script type="text/javascript" src="js/CswAll.min.js"></script> 
    <script type="text/javascript">

        $(document).ready(function () {

            function stopSpinner() {
                $('#spinner').hide();
            }

            function showCrystal(reportid) {
                Csw.ajax.post({
                    url: '/NbtWebApp/wsNBT.asmx/doesReportSupportCrystal',
                    data: { reportid: reportid },
                    success: function (data) {
                        if (Csw.bool(data.result)) {
                            $('#btnCrystal').css('display', '');
                        }
                    }
                });
            }

            Csw.subscribe(Csw.enums.events.ajax.globalAjaxStop, stopSpinner);

            var qs = Csw.queryString();
            if (false == Csw.isNullOrEmpty(qs.reportid)) {
                showCrystal(qs.reportid);
                if (false == Csw.isNullOrEmpty(qs.rformat)) {
                    runReport(qs.reportid, qs.rformat);
                } else {
                    $('#btnGrid').click(function () { runReport(qs.reportid, 'grid'); });
                    $('#btnCsv').click(function () { runReport(qs.reportid, 'csv'); });
                    $('#btnCrystal').click(function () { window.location = 'report.aspx?reportid=' + qs.reportid; });
                }
            }
        });



        function runReport(reportid, rformat) {

            function startSpinner() {
                $('#spinner').show();
            }


            if ('csv' == rformat.toLowerCase()) {
                window.location = '/NbtWebApp/wsNBT.asmx/report?rformat=csv&reportid=' + reportid;
            }
            else {

                Csw.subscribe(Csw.enums.events.ajax.globalAjaxStart, startSpinner);
                Csw.ajax.post({
                    url: '/NbtWebApp/wsNBT.asmx/report',
                    data: { reportid: reportid, rformat: 'grid' },
                    overrideerror: true,
                    success: function (data) {
                        //jobject data from the ws call
                        var gridOptions = {
                            ID: Csw.makeId('reportGrid'),
                            //$parent: $('#rptDiv'),
                            gridOpts: {}
                        };
                        $.extend(gridOptions.gridOpts, data.griddata);
                        gridOptions.gridOpts.autowidth = true;
                        gridOptions.gridOpts.rowNum = 100000;
                        gridOptions.gridOpts.rowList = [100000];
                        var parent = Csw.literals.factory($('#rptDiv'));
                        var grid = parent.grid(gridOptions);
                    }
                });

            }
        }

        
    </script>
</head>
<body>
    <div id="formatChooser">
        <input type="button" value="View As Grid" id="btnGrid" />
        <input type="button" value="Save As CSV" id="btnCsv" />
        <input type="button" value="View Using Crystal Reports" id="btnCrystal" style="display: none;" />
    </div>
    <div id="spinner" width="100%" style="text-align: center; display: none;">
        <img src="images/ajax/progress.gif" /></div>
    <div id="rptDiv">
    </div>
    <div id="DialogErrorDiv"></div>
</body>
</html>
