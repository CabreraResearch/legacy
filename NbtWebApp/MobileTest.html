<!DOCTYPE html>
<html>
<head>
    <title>Page Title</title>
    <link href="http://code.jquery.com/mobile/latest/jquery.mobile.min.css" rel="stylesheet"
        type="text/css" />
    <script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/latest/jquery.mobile.min.js"></script>
    <script type="text/javascript" src="js/_Global.js"></script>
</head>
<body id='CswMobile'>
    
    
    <script type="text/javascript">

        var currentPath = ( $.mobile.path.get() !== 'localhost' ) ? $.mobile.path.get() : '';

        function bindJqm($div)
        {

//            $('div[data-role="page"]').each(function ()
//            {

                $div.bind('pageshow', function ()
                {
                    var $this = $(this); //.page();
                    loadContent($this);
                });
//            });
                return $div;
        }

        function loadContent($div)
        {
            $.mobile.pageLoading();
            
            var $content = $div.find('div:jqmData(role="content")').empty();
            var $ul = $('<ul data-role="listview" data-theme="b"></ul>'); //.listview();
            $content.append($ul);
            $ul.listview();

            // hack: JQM keeps updating path as concatenation of localhost + data-url, which breaks AJAX
            if ($.mobile.path.get() !== '') $.mobile.path.set('');
            //$.mobile.path.get = function (newPath) { return ''; };
            CswAjaxJSON({
                url: '/NbtWebApp/wsNBT.asmx/GetTestData',
                data: {},
                success: function (links)
                {
                    for (prop in links)
                    {
                        log(prop);
                        var id = links[prop].replace(' ', '').replace(' ', '');
                        var text = links[prop];
                        var $li = $('<li><a data-identity="' + id + '" data-url="' + id + '" href="javascript:void(0);" >' + text + '</a></li>');

                        $ul.append($li);
                        $ul.listview('refresh');
                        $newPage = bindJqm( makePage(id, text) );
                        $li.find('a').bind('click', function ()
                        {
                            var dataurl = $(this).attr('data-url');
                            var $thisPage = $('#' + dataurl);
                            $.mobile.changePage($thisPage);
                        });
                    }
                    //bindJqm();

                },
                error: function (xml)
                {
                    log(xml);
                }
            });

            $.mobile.pageLoading(true);
        }

        function makePage(id,text)
        {
            var $page = $('#' + id);
            if ($page === undefined || $page.length === 0)
            {
                $page = $('<div id="' + id + '" ' + 'data-role="page" data-url="' + id + '">')
                        .appendTo($('body'));

                var $header = $('<div id="Header_' + id + '" ' + 'data-role="header"><h1>Header of ' + text + '</h1>')
                          .appendTo($page);

                var $content = $('<div id="Content_' + id + '" ' + 'data-role="content">')
                           .appendTo($page);

                $page.append('<div id="Footer_' + id + '" ' + 'data-role="footer">');

                //$page.page();
            }
            return $page;
        }

        var $static1 = $('<div id="StaticPage1" data-role="page" data-url="StaticPage1"><div id="StaticHeader1" data-role="header"><h1>Static Header 1</h1></div><div id="StaticContent1" data-role="content" ></div></div>');
        var $static2 = $('<div id="StaticPage2" data-role="page" data-url="StaticPage2"><div id="StaticHeader2" data-role="header"><h1>Static Header 2</h1></div><div id="StaticContent2" data-role="content" ></div></div>');
        
        $('body').append($static1).append($static2);
        
        var $currentPage = $('#' + currentPath);
        $currentPage = ($currentPage === $static1) ? $static1 : makePage(currentPath, currentPath);
        
        $('div[data-role="page"]').each(function ()
        {
            var $div = $(this);
            bindJqm($div);
        });

        $currentPage.page();

//        if ($currentPage === $static1)
//        {
//            $static1.page();
//        }
//        else
//        {
//            //loadContent($currentPage);
//            $currentPage.page();
//        }

        //$.mobile.changePage($static1,'',true,false);
    </script>
</body>
</html>
