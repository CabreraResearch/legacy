<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--#include file="NewHeader.html" -->

					<tr>
						<td id="Td5" class="PageTable_LeftColumn" rowspan="5">
							<img src="Images/pagelayout/blank.gif" alt="X" width="1" height="450"/>
						</td>

						<td id="HeaderTable_BottomMenu" class="HeaderTable_BottomMenu" colspan="2">
							<table cellpadding="0" cellspacing="0">
								<tr>
									<td><img id="headerblank4" src="Images/pagelayout/blank.gif" alt="X" width="1" height="30"/></td>
									<td><div id="MainMenuDiv"></div></td>
								</tr>
                                <tr>
                                    <td></td>
                                    <td><div id="ViewSelectDiv"></div></td>
                                </tr>
							</table>
						</td>

						<td id="Td6" class="PageTable_RightColumn" rowspan="5"></td>
					</tr>

					<tr>
						<td colspan="2">
							<div id="ErrorDiv" class="ErrorContent" style="display: none;"></div>
						</td>
					</tr>

                    <tr>
                        <td id="Td7" class="PageTable_CenterCell" colspan="2" valign="top">
                            <div id="CenterTopDiv"></div>
                        </td>
                    </tr>
		  
					<tr>
						<td id="Td8" class="PageTable_LeftCell" valign="top">
							
							<div id="LeftDiv"></div>
						</td>
						<td id="Td9" class="PageTable_RightCell" valign="top" style="padding-left: 5px;">
							<div id="RightDiv"></div>
						</td>
					</tr>
                    
                    <tr>
                        <td id="Td10" class="PageTable_CenterCell" colspan="2" valign="top">
                            <div id="CenterBottomDiv"></div>
                        </td>
                    </tr>

					<tr>
						<td id="Td11" class="PageTable_CenterCell" colspan="2" valign="top">
							<div id="QuickLaunch"></div>
						</td>
					</tr>


<script type="text/javascript">

	var debug = false;

	initAll();

	var MainTreeId = 'main';
	var MainGridId = 'CswNodeGrid';
	var MainSearchId = 'CswSearchForm';

	function initAll()
	{
		if (debug) log('NewMain.initAll()');

		$('#CenterBottomDiv').CswLogin('login', {
			'onAuthenticate': function (u)
			{
				var view = {
					'viewid': $.CswCookie('get', CswCookieName.CurrentView.ViewId),
					'viewmode': $.CswCookie('get', CswCookieName.CurrentView.ViewMode)
				};
				$('#header_username').text(u);
				$('#header_dashboard').CswDashboard({
					'onSuccess': function ()
					{
						$('#header_menu').CswMenuHeader({
							'onLogout': function ()
							{
								$('#CenterBottomDiv').CswLogin('logout', {
									onDeauthenticate: function ()
									{
										$.CswCookie('clearAll');
										window.location = 'NewMain.html';
									}
								});
							},
							'onSuccess': function ()
							{
								$('#ViewSelectDiv').CswViewSelect({
									'ID': 'mainviewselect',
									'onSelect': handleItemSelect,
									'onSuccess': function ()
									{

										$('#QuickLaunch').CswQuickLaunch({
											'onLinkClick': handleItemSelect,
											'onSuccess': function ()
											{
												if (view.viewid == '')
												{
													refreshWelcome();
												} else
												{
													handleItemSelect({ 'viewid': view.viewid, viewmode: view.viewmode });
												}
											} // onSuccess
										}); // CswQuickLaunch
									}  // onSuccess
								}); // CswViewSelect
							} // onSuccess
						}); // CswMenuHeader
					} // onSuccess
				}); // CswDashboard
			} // onAuthenticate
		}); // CswLogin
	} // initAll()

	function clear(options)
	{
		if (debug) log('NewMain.clear()');

		var o = {
			left: false, 
			right: false, 
			centertop: false,
            centerbottom: false,
			all: false
		};
		if(options) {
			$.extend(o,options);
		}

		if (o.all || o.left)
		{
			$('#LeftDiv').empty();
		}
		if (o.all || o.right)
		{
			$('#RightDiv').empty();
		}
		if (o.all || o.centertop)
		{
            $('#CenterTopDiv').empty();
		}
        	if (o.all || o.centerbottom)
		{
    		$('#CenterBottomDiv').empty();
		}
		if (o.all)
		{
			$('#MainMenuDiv').empty();
		}
	}

	function refreshWelcome()
	{
		if (debug) log('NewMain.refreshWelcome()');

		clear({ all: true });
		$('#CenterBottomDiv').CswWelcome('initTable', {
			'onLinkClick': handleItemSelect,
			'onAddClick': function (nodetypeid)
			{
				$.CswDialog('AddNodeDialog', {
					'nodetypeid': nodetypeid,
					'onAddNode': function (nodeid, cswnbtnodekey)
					{
						clear({ all: true });
						refreshNodesTree({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey, 'IncludeNodeRequired': true });
					}
				});
			},
			'onAddComponent': refreshWelcome
		});
        refreshMainMenu();
	} // refreshWelcome()

	function handleItemSelect(options)
	{
		if (debug) log('NewMain.handleItemSelect()');

		if (manuallyCheckChanges())
		{
			clear({ all: true });
			var o = {
				type: 'view',
				viewmode: 'tree',
				itemid: '',
				text: '',
				iconurl: '',
				viewid: '',
				actionid: '',
				reportid: '',
				linktype: '',
				nodeid: '',
				cswnbtnodekey: ''
			};
			if (options) $.extend(o, options);

			if (o.viewid != undefined && o.viewid != '')
			{
			    $.CswCookie('set', CswCookieName.CurrentView.ViewId, o.viewid);
			    $.CswCookie('set', CswCookieName.CurrentView.ViewMode, o.viewmode);

			    switch (o.viewmode) //webservice converts to lower case
			    {
			        case 'grid':
			            {
			                getViewGrid({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
			                break;
			            }
			        default:
			            {
			                refreshNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode, 'nodeid': '', 'cswnbtnodekey': '' });
			                break;
			            }
			    }
			}
			else if (o.type != undefined && o.type != '')
			{
			    switch (o.type)
			    {
			        case 'action':
			            {
			                alert('Actions are not yet handled!');
			                break;
			            }
			        case 'report':
			            {
			                alert('Reports are not yet handled!');
			                break;
			            }
			        default:
			            {
			                alert('Handling for link type ' + o.linktype + ' is not implemented yet.');
			                break;
			            }
			    }
			}
			else
			{
			    alert('Handling for this action is not yet implemented');
			}
		} // if (manuallyCheckChanges())
	} // handleItemSelect()

	function refreshMainMenu(options) 
	{
		if (debug) log('NewMain.refreshMainMenu()');

		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: '',
            prefix: 'csw'
		};

		if (options)
		{
			$.extend(o, options);
		}

		$('#MainMenuDiv').CswMenuMain({
		    'viewid': o.viewid,
		    'nodeid': o.nodeid,
		    'cswnbtnodekey': o.cswnbtnodekey,
		    'onAddNode': function (nodeid, cswnbtnodekey)
		    {
		        refreshSelected({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey });
		    },
		    'onMultiEdit': function ()
		    {
		        multi = !multi;
		        refreshSelected({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
		    },
		    'onSearch':
                {
                    'onViewSearch': function ()
                    {
                        var genericSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'generic' });
                        var viewSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'view' });
                        var $searchForm = refreshSearchPanel({ 'genericSearchId': genericSearchId,
                                                               'viewSearchId': viewSearchId,
                                                               'searchType': 'view',
                                                               'cswnbtnodekey': o.cswnbtnodekey,
                                                               'viewid': o.viewid
                                                            });
                    },
                    'onGenericSearch': function ()
                    {
                        var genericSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'generic' });
                        var viewSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'view' });
                        var $searchForm = refreshSearchPanel({ 'genericSearchId': genericSearchId,
                                                               'viewSearchId': viewSearchId,
                                                               'searchType': 'generic',
                                                               'cswnbtnodekey': o.cswnbtnodekey
                                                           });
                    }
                },
		    'onEditView': function (viewid)
		    {
		        clear({ 'all': true });
		        $('#CenterTopDiv').CswViewEditor({
		            'viewid': $.CswCookie('get', CswCookieName.CurrentView.ViewId),
		            'onCancel': function ()
		            {
		                clear({ 'all': true });
		                refreshSelected();
		            },
		            'onFinish': function (viewid, viewmode)
		            {
		                clear({ 'all': true });
		                handleItemSelect({ 'viewid': viewid, 'viewmode': viewmode });
		            }
		        });
		    },
		    'Multi': multi,
		    'NodeCheckTreeId': MainTreeId
		});
	}

	function refreshSearchPanel(options)
	{
	    if (debug) log('NewMain.refreshSearchPanel()');
	    
        var o = {
	        viewid: '',
	        nodetypeid: '',
	        cswnbtnodekey: '',
	        viewSearchId: '',
	        genericSearchId: '',
            searchType: 'generic'
	    };
        
	    if (options) $.extend(o, options);

	    var $viewSearch = $('#CenterTopDiv').CswDOM('getchildren', { 'ID': o.viewSearchId });
	    var $genericSearch = $('#CenterTopDiv').CswDOM('getchildren', { 'ID': o.genericSearchId });
        var $thisSearchForm;

	    switch (o.searchType)
	    {
	        case 'generic':
	            {
	                if ($genericSearch === undefined || $genericSearch.size() === 0)
	                {
	                    //supplying no viewid guarantees a generic search
	                    $genericSearch = makeSearchForm({ 'cswnbtnodekey': o.cswnbtnodekey, 'ID': o.genericSearchId });
	                }
	                else if ($genericSearch.is(':hidden'))
	                {
	                    $genericSearch.show();
	                }
	                else
	                {
	                    $genericSearch.hide();
	                }
	                $thisSearchForm = $genericSearch;
	                break;
	            }
	        case 'view':
	            {
	                if ($viewSearch === undefined || $viewSearch.size() === 0)
	                {
	                    $viewSearch = makeSearchForm({ 'viewid': o.viewid, 'cswnbtnodekey': o.cswnbtnodekey, 'ID': o.viewSearchId });
	                }
	                else if ($viewSearch.is(':hidden'))
	                {
	                    $viewSearch.show();
	                }
	                else
	                {
	                    $viewSearch.hide();
	                }
	                $thisSearchForm = $viewSearch;
	                break;
	            }
	    }
        return $thisSearchForm;
    }

    function makeSearchForm(options)
    {
        var o = {
            viewid: '',
            nodetypeid: '',
            cswnbtnodekey: '',
            ID: ''
        }
        if (options) $.extend(o, options);

        clear({ centertop: true });

        var onSearchSubmit = function (view)
        {
            clear({ right: true });
            $.CswCookie('set', CswCookieName.CurrentView.ViewId, view.viewid);
            $.CswCookie('set', CswCookieName.CurrentView.ViewMode, view.viewmode);
            refreshSelected({
                viewmode: view.viewmode,
                viewid: view.viewid,
                cswnbtnodekey: '', //do not want a view of only this node
                nodeid: ''
            });
        };
        var $search = $('#CenterTopDiv').CswSearch({
                                    'viewid': o.viewid,
                                    'cswnbtnodekey': o.cswnbtnodekey,
                                    'nodetypeid': o.nodetypeid,
                                    'ID': o.ID,
                                    'onSearchSubmit': onSearchSubmit
                                });
        return $search;
    }

	function getViewGrid(options)
	{
		if (debug) log('NewMain.getViewGrid()');

		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: '',
            doMenuRefresh: true,
            onAddNode: '',
            onEditNode: '',
            onDeleteNode: ''
		};
		if (options) $.extend(o, options);

		// Defaults
		if (o.nodeid == '' || o.nodeid == undefined)
			o.nodeid = $.CswCookie('get', CswCookieName.CurrentNode.NodeId);
		if (o.cswnbtnodekey == '')
			o.cswnbtnodekey = $.CswCookie('get', CswCookieName.CurrentNode.NodeKey);
		if (o.viewid != '')
			$.CswCookie('get', CswCookieName.CurrentView.ViewId);

		o.onAddNode = function (nodeid, cswnbtnodekey)
			{
				var ocopy = o;
				var x = { 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey };
				$.extend(ocopy, x);
				getViewGrid(ocopy);
			};
        o.onEditNode = function() { getViewGrid(o); };
        o.onDeleteNode = function() { getViewGrid(o); };
        
        clear({ centerbottom: true});
        
        $('#CenterBottomDiv').CswNodeGrid({ 
                                'viewid': o.viewid, 
                                'nodeid': o.nodeid, 
                                'cswnbtnodekey': o.cswnbtnodekey, 
                                'prefix': MainGridId, 
                                'onAddNode': o.onAddNode,
                                'onEditNode': o.onEditNode,
                                'onDeleteNode': o.onDeleteNode });
        if(o.doMenuRefresh) refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
	}

	function onSelectTreeNode(options)
	{
		if (debug) log('NewMain.onSelectTreeNode()');

		if (manuallyCheckChanges())
		{
			var o = {
				viewid: '',
				nodeid: '',
				nodename: '',
				iconurl: '',
				cswnbtnodekey: ''
			};
			if (options)
			{
				$.extend(o, options);
			}

			$.CswCookie('set', CswCookieName.CurrentNode.NodeId, o.nodeid);
			$.CswCookie('set', CswCookieName.CurrentNode.NodeKey, o.cswnbtnodekey);

			if (o.nodeid != '' && o.nodeid != 'root')
			{
				getTabs({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
				refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
			} 
			else
			{
				clear({ 'right': true });
				refreshMainMenu({ 'viewid': o.viewid, 'nodeid': '', 'cswnbtnodekey': '' });
			}
		}
	} // onSelectTreeNode()

	function getTabs(options)
	{
		if (debug) log('NewMain.getTabs()');

		var o = {
			nodeid: '',
			cswnbtnodekey: ''
		};
		if (options)
		{
			$.extend(o, options);
		}

		clear({ right: true });
		$('#RightDiv').CswNodeTabs({
			'ID': 'nodetabs',
			'nodeid': o.nodeid,
			'cswnbtnodekey': o.cswnbtnodekey,
			'onSave': function (nodeid, cswnbtnodekey)
			{
				unsetChanged();
				refreshSelected({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey });
			},
			'tabid': $.CswCookie('get', CswCookieName.CurrentTabId),
			'onBeforeTabSelect': function (tabid)
			{
				return manuallyCheckChanges();
			},
			'onTabSelect': function (tabid)
			{
				$.CswCookie('set', CswCookieName.CurrentTabId, tabid);
			},
			'onPropertyChange': function (propid, propname)
			{
				//if(debug) log('Property Changed: propid = ' + propid + ', propname = ' + propname);
				setChanged();
			},
			'ShowCheckboxes': multi,
			'NodeCheckTreeId': MainTreeId
		});
	}

	function refreshSelected(options)
	{
		if (debug) log('NewMain.refreshSelected()');

		if (manuallyCheckChanges())
		{
			var o = {
				nodeid: '',
				cswnbtnodekey: '',
				nodename: '',
				iconurl: '',
                viewid: '',
			    viewmode: 'tree'
			};
			if (options) $.extend(o, options);
			
			switch (o.viewmode)
			{
				case 'grid':
					{
						getViewGrid({
                            'viewid': o.viewid,
			                'nodeid': o.nodeid,
			                'cswnbtnodekey': o.cswnbtnodekey
                        });
						break;
					}
				default: //tree
					{
						refreshNodesTree({
							'nodeid': o.nodeid,
							'cswnbtnodekey': o.cswnbtnodekey,
							'nodename': o.nodename,
                            'viewid': o.viewid,
                            'viewmode': o.viewmode
						});
						break;
					}
			} // switch
		} // if (manuallyCheckChanges())
	} // refreshSelected()

	var multi = false;

	function refreshNodesTree(options)
	{
		if (debug) log('NewMain.refreshNodesTree()');

		var o = {
			'nodeid': '',
			'cswnbtnodekey': '',
			'nodename': '', 
			'iconurl': '',
			'viewid': '',
			'viewmode': 'tree',
			'IncludeNodeRequired': false
		};		
		if (options) $.extend(o, options);

		if (o.nodeid == '' || o.nodeid == undefined)
			o.nodeid = $.CswCookie('get', CswCookieName.CurrentNode.NodeId);
		if (o.cswnbtnodekey == '')
			o.cswnbtnodekey = $.CswCookie('get', CswCookieName.CurrentNode.NodeKey);
		if (o.viewid == '')
			o.viewid = $.CswCookie('get', CswCookieName.CurrentView.ViewId);

		clear({ left: true });

		$('#LeftDiv').CswNodeTree('init', { 'ID': MainTreeId,
											'viewid': o.viewid,
											'viewmode': o.viewmode,
											'nodeid': o.nodeid, 
											'cswnbtnodekey': o.cswnbtnodekey,
											'nodename': o.nodename,
											'IncludeNodeRequired': o.IncludeNodeRequired,
											'onViewChange': function (newviewid)
												{
													$.CswCookie('set', CswCookieName.CurrentView.ViewId, newviewid);
												},
											'onSelectNode': function (optSelect)
												{
										   			onSelectTreeNode({
																		'viewid': optSelect.viewid,
																		'nodeid': optSelect.nodeid,
																		'cswnbtnodekey': optSelect.cswnbtnodekey
																	});
												},
											'ShowCheckboxes': multi
										}); // CswNodesTree
	} // refreshNodesTree()

</script>

<!--#include file="NewFooter.html" -->
