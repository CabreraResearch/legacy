<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--#include file="NewHeader.html" -->

					<tr>
						<td id="Td5" class="PageTable_LeftColumn" rowspan="6">
							<img src="Images/pagelayout/blank.gif" alt="X" width="1" height="450"/>
						</td>

						<td id="HeaderTable_BottomMenu" class="HeaderTable_BottomMenu" colspan="2">
							<table cellpadding="0" cellspacing="0">
								<tr>
									<td><img id="headerblank4" src="Images/pagelayout/blank.gif" alt="X" width="1" height="30"/></td>
									<td><div id="MainMenuDiv"></div></td>
								</tr>
                                <tr>
                                    <td></td>
                                    <td><div id="ViewSelectDiv"></div></td>
                                </tr>
							</table>
						</td>

						<td id="Td6" class="PageTable_RightColumn" rowspan="6"></td>
					</tr>

					<tr>
						<td colspan="2">
							<div id="ErrorDiv" style="display: none;"></div>
						</td>
					</tr>

                    <tr>
                        <td id="Td7" class="PageTable_CenterCell" colspan="2" valign="top">
                            <div id="CenterTopDiv"></div>
                        </td>
                    </tr>
		  
					<tr>
						<td id="Td8" class="PageTable_LeftCell" valign="top">
							
							<div id="LeftDiv"></div>
						</td>
						<td id="Td9" class="PageTable_RightCell" valign="top" style="padding-left: 5px;">
							<div id="RightDiv"></div>
						</td>
					</tr>
                    
                    <tr>
                        <td id="Td10" class="PageTable_CenterCell" colspan="2" valign="top">
                            <div id="CenterBottomDiv"></div>
                        </td>
                    </tr>

					<tr>
						<td id="Td11" class="PageTable_CenterCell" colspan="2" valign="top">
							<div id="QuickLaunch"></div>
						</td>
					</tr>


<script type="text/javascript">

	var debug = false;

	var MainTreeId = 'main';
	var MainGridId = 'CswNodeGrid';
	var MainSearchId = 'CswSearchForm';


	// handle querystring arguments
	var qs = $.CswQueryString();
	if (!isNullOrEmpty(qs.viewid))
	{
		// set the view
		var viewmode = tryParseString(qs.viewmode, 'tree');
		$.CswCookie('set', CswCookieName.CurrentViewId, qs.viewid),
		$.CswCookie('set', CswCookieName.CurrentViewMode, viewmode)
		// clear the querystring
		window.location = "NewMain.html";
	} else
	{
		initAll();
	}


	function initAll()
	{
		if (debug) log('NewMain.initAll()');

		$('#CenterBottomDiv').CswLogin('login', {
			'onAuthenticate': function (u)
			{
				var view = {
					'viewid': $.CswCookie('get', CswCookieName.CurrentViewId),
					'viewmode': $.CswCookie('get', CswCookieName.CurrentViewMode)
				};
				$('#header_username').text(u);
				$('#header_dashboard').CswDashboard();

				$('#header_menu').CswMenuHeader({
					'onLogout': function ()
					{
						$('#CenterBottomDiv').CswLogin('logout', {
							'onDeauthenticate': function ()
							{
								$.CswCookie('clearAll');
								window.location = 'NewMain.html';
							} // onDeauthenticate
						}); // CswLogin
					} // onLogout
				}); // CswMenuHeader

				$('#ViewSelectDiv').CswViewSelect({
					'ID': 'mainviewselect',
					'onSelect': handleItemSelect
				}); // CswViewSelect

				refreshQuickLaunch();

				if (view.viewid === '')
				{
					refreshWelcome();
				} else
				{
					handleItemSelect({ 'viewid': view.viewid, viewmode: view.viewmode });
				}
			} // onAuthenticate
		});  // CswLogin

	} // initAll()

	function refreshQuickLaunch()
	{
		$('#QuickLaunch').contents().remove();

		$('#QuickLaunch').CswQuickLaunch({
			'onLinkClick': handleItemSelect
		}); // CswQuickLaunch
	}


	function clear(options)
	{
		if (debug) log('NewMain.clear()');

		var o = {
			left: false, 
			right: false, 
			centertop: false,
            centerbottom: false,
			all: false
		};
		if(options) {
			$.extend(o,options);
		}

		if (o.all || o.left)
		{
			$('#LeftDiv').empty();
		}
		if (o.all || o.right)
		{
			$('#RightDiv').empty();
		}
		if (o.all || o.centertop)
		{
            $('#CenterTopDiv').empty();
		}
        	if (o.all || o.centerbottom)
		{
    		$('#CenterBottomDiv').empty();
		}
		if (o.all)
		{
			$('#MainMenuDiv').empty();
		}
	}

	function refreshWelcome()
	{
		if (debug) log('NewMain.refreshWelcome()');
        clear({ all: true });

        $('#CenterBottomDiv').CswWelcome('initTable', {
            'onLinkClick': handleItemSelect,
            'onSearchClick': function (view)
            {
                var viewid = view.viewid;
                var viewmode = view.viewmode;
                handleItemSelect({ 'viewid': viewid, 'viewmode': viewmode, 'linktype': 'search' });
                refreshSearchPanel({ 'viewid': viewid, 'searchType': 'view' });
            },
            'onAddClick': function (nodetypeid)
            {
                $.CswDialog('AddNodeDialog', {
                    'nodetypeid': nodetypeid,
                    'onAddNode': function (nodeid, cswnbtnodekey)
                    {
                        clear({ all: true });
                        refreshNodesTree({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey, 'IncludeNodeRequired': true });
                    }
                });
            },
            'onAddComponent': refreshWelcome
        });
        refreshMainMenu();
	} // refreshWelcome()

	function handleItemSelect(options)
	{
		if (debug) log('NewMain.handleItemSelect()');

		if (manuallyCheckChanges())
		{
			clear({ all: true });
			var o = {
				type: 'view', // Action, Report, View
				viewmode: 'tree', // Grid, Tree, List
				linktype: 'link', // WelcomeComponentType: Link, Search, Text, Add
                viewid: '',
				actionurl: '',
				reportid: '',
				nodeid: '',
				cswnbtnodekey: ''
			};
			if (options) $.extend(o, options);

			if ( !isNullOrEmpty( o.viewid ) )
			{
			    $.CswCookie('set', CswCookieName.CurrentViewId, o.viewid);
			    $.CswCookie('set', CswCookieName.CurrentViewMode, o.viewmode);

			    var linkOpt = {
                    'showempty': false,
                    'forsearch': false
			    };

			    switch (o.linktype.toLowerCase())
			    {
			        case 'search':
			            linkOpt.showempty = true;
			            linkOpt.forsearch = true;
			            break;
			    }

			    switch ( o.viewmode.toLowerCase() )
			    {
			    	case 'grid':
			    	    {
			    	        getViewGrid({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 'showempty': linkOpt.showempty, 'forsearch': linkOpt.forsearch });
			                break;
			            }
			        default:
			            {
			                refreshNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode, 'nodeid': '', 'cswnbtnodekey': '', 'showempty': linkOpt.showempty, 'forsearch': linkOpt.forsearch });
			                break;
			            }
			    }
			}
			else if (!isNullOrEmpty(o.type))
			{
			    switch ( o.type.toLowerCase() )
			    {
			    	case 'action':
			    		{
			    			window.location = o.actionurl;
			    			break;
			    		}
			    	case 'report':
			    		{
			    			window.location = "Report.aspx?reportid=" + o.reportid;
			    			break;
			    		}
			        default:
			            {
			                alert('Handling for link type ' + o.type + ' is not implemented yet.');
			                break;
			            }
			    }
			}
			else
			{
			    alert('Handling for this action is not yet implemented');
			}

			refreshQuickLaunch();

		} // if (manuallyCheckChanges())
	} // handleItemSelect()

	function refreshMainMenu(options) 
	{
		if (debug) log('NewMain.refreshMainMenu()');

		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: '',
            prefix: 'csw'
		};

		if (options)
		{
			$.extend(o, options);
		}

		$('#MainMenuDiv').CswMenuMain({
			'viewid': o.viewid,
			'nodeid': o.nodeid,
			'cswnbtnodekey': o.cswnbtnodekey,
			'onAddNode': function (nodeid, cswnbtnodekey)
			{
				refreshSelected({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey, 'IncludeNodeRequired': true });
			},
			'onMultiEdit': function ()
			{
				multi = !multi;
				refreshSelected({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
			},
			'onSearch':
                {
                	'onViewSearch': function ()
                	{
                		var genericSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'generic' });
                		var viewSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'view' });
                		var $searchForm = refreshSearchPanel({ 'genericSearchId': genericSearchId,
                			'viewSearchId': viewSearchId,
                			'searchType': 'view',
                			'cswnbtnodekey': o.cswnbtnodekey,
                			'viewid': o.viewid
                		});
                	},
                	'onGenericSearch': function ()
                	{
                		var genericSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'generic' });
                		var viewSearchId = makeId({ 'ID': MainSearchId, prefix: o.prefix, suffix: 'view' });
                		var $searchForm = refreshSearchPanel({ 'genericSearchId': genericSearchId,
                			'viewSearchId': viewSearchId,
                			'searchType': 'generic',
                			'cswnbtnodekey': o.cswnbtnodekey
                		});
                	}
                },
			'onEditView': function (viewid)
			{
				clear({ 'all': true });
				$('#CenterTopDiv').CswViewEditor({
					'viewid': $.CswCookie('get', CswCookieName.CurrentViewId),
					'viewmode': $.CswCookie('get', CswCookieName.CurrentViewMode),
					'onCancel': function ()
					{
						clear({ 'all': true });
						refreshSelected();
					},
					'onFinish': function (viewid, viewmode)
					{
						clear({ 'all': true });
						handleItemSelect({ 'viewid': viewid, 'viewmode': viewmode });
					}
				});
			},
			'Multi': multi,
			'NodeCheckTreeId': MainTreeId
		});
	}

	function refreshSearchPanel(options)
	{
	    if (debug) log('NewMain.refreshSearchPanel()');
	    
        var o = {
	        viewid: '',
	        nodetypeid: '',
	        cswnbtnodekey: '',
	        viewSearchId: '',
	        genericSearchId: '',
            searchType: 'generic'
	    };
        
	    if (options) $.extend(o, options);

	    var $viewSearch = $('#CenterTopDiv').children('#' + o.viewSearchId);
	    var $genericSearch = $('#CenterTopDiv').children('#' + o.genericSearchId);
        var $thisSearchForm;

	    switch ( o.searchType.toLowerCase() )
	    {
	        case 'generic':
	            {
	                if ($genericSearch === undefined || $genericSearch.size() === 0)
	                {
	                    //supplying no viewid guarantees a generic search
	                    $genericSearch = makeSearchForm({ 'cswnbtnodekey': o.cswnbtnodekey, 'ID': o.genericSearchId });
	                }
	                else if ($genericSearch.is(':hidden'))
	                {
	                    $genericSearch.show();
	                }
	                else
	                {
	                    $genericSearch.hide();
	                }
	                $thisSearchForm = $genericSearch;
	                break;
	            }
	        case 'view':
	            {
	                if ($viewSearch === undefined || $viewSearch.size() === 0)
	                {
	                    $viewSearch = makeSearchForm({ 'viewid': o.viewid, 'cswnbtnodekey': o.cswnbtnodekey, 'ID': o.viewSearchId });
	                }
	                else if ($viewSearch.is(':hidden'))
	                {
	                    $viewSearch.show();
	                }
	                else
	                {
	                    $viewSearch.hide();
	                }
	                $thisSearchForm = $viewSearch;
	                break;
	            }
	    }
        return $thisSearchForm;
    }

    function makeSearchForm(options)
    {
        var o = {
            viewid: '',
            nodetypeid: '',
            cswnbtnodekey: '',
            ID: ''
        }
        if (options) $.extend(o, options);

        clear({ centertop: true });

        var onSearchSubmit = function (view)
        {
            clear({ right: true });
            $.CswCookie('set', CswCookieName.CurrentViewId, view.viewid);
            var viewMode = view.viewmode;
            if (viewMode === 'list') viewMode = 'tree';
            $.CswCookie('set', CswCookieName.CurrentViewMode, viewMode);
            refreshSelected({
                viewmode: viewMode,
                viewid: view.viewid,
                forsearch: true,
                showempty: false,
                cswnbtnodekey: '', //do not want a view of only this node
                nodeid: ''
            });
        };
        var $search = $('#CenterTopDiv').CswSearch({
                                    'viewid': o.viewid,
                                    'cswnbtnodekey': o.cswnbtnodekey,
                                    'nodetypeid': o.nodetypeid,
                                    'ID': o.ID,
                                    'onSearchSubmit': onSearchSubmit
                                });
        return $search;
    }

	function getViewGrid(options)
	{
		if (debug) log('NewMain.getViewGrid()');

		var o = {
			viewid: '',
			nodeid: '',
            showempty: false,
			cswnbtnodekey: '',
            doMenuRefresh: true,
            onAddNode: '',
            onEditNode: '',
            onDeleteNode: ''
		};
		if (options) $.extend(o, options);

		// Defaults
		var getEmptyGrid = (isTrue(o.showempty));
        if ( isNullOrEmpty( o.nodeid ) )
			o.nodeid = $.CswCookie('get', CswCookieName.CurrentNodeId);
		if ( isNullOrEmpty(o.cswnbtnodekey) )
			o.cswnbtnodekey = $.CswCookie('get', CswCookieName.CurrentNodeKey);
		if ( !isNullOrEmpty(o.viewid) )
			$.CswCookie('get', CswCookieName.CurrentViewId);

//		o.onAddNode = function (nodeid, cswnbtnodekey)
//			{
//				var ocopy = o;
//				var x = { 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey };
//				$.extend(ocopy, x);
//				getViewGrid(ocopy);
//			};
        o.onEditNode = function() { getViewGrid(o); };
        o.onDeleteNode = function() { getViewGrid(o); };
        
        clear({ centerbottom: true});
        
        $('#CenterBottomDiv').CswNodeGrid({ 
                                'viewid': o.viewid, 
                                'nodeid': o.nodeid,
                                'cswnbtnodekey': o.cswnbtnodekey, 
                                'showempty': getEmptyGrid,
                                'ID': MainGridId, 
                                //'onAddNode': o.onAddNode,
                                'onEditNode': o.onEditNode,
                                'onDeleteNode': o.onDeleteNode });
        if(o.doMenuRefresh) refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
	}

	function onSelectTreeNode(options)
	{
		if (debug) log('NewMain.onSelectTreeNode()');

		if (manuallyCheckChanges())
		{
			var o = {
				viewid: '',
				nodeid: '',
				nodename: '',
				iconurl: '',
				cswnbtnodekey: ''
			};
			if (options)
			{
				$.extend(o, options);
			}

			$.CswCookie('set', CswCookieName.CurrentNodeId, o.nodeid);
			$.CswCookie('set', CswCookieName.CurrentNodeKey, o.cswnbtnodekey);

			if (o.nodeid !== '' && o.nodeid !== 'root')
			{
				getTabs({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
				refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
			} 
			else
			{
				clear({ 'right': true });
				refreshMainMenu({ 'viewid': o.viewid, 'nodeid': '', 'cswnbtnodekey': '' });
			}
		}
	} // onSelectTreeNode()

	function getTabs(options)
	{
		if (debug) log('NewMain.getTabs()');

		var o = {
			nodeid: '',
			cswnbtnodekey: ''
		};
		if (options)
		{
			$.extend(o, options);
		}

		clear({ right: true });
		$('#RightDiv').CswNodeTabs({
			'ID': 'nodetabs',
			'nodeid': o.nodeid,
			'cswnbtnodekey': o.cswnbtnodekey,
			'onSave': function (nodeid, cswnbtnodekey)
			{
				unsetChanged();
				refreshSelected({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey });
			},
			'tabid': $.CswCookie('get', CswCookieName.CurrentTabId),
			'onBeforeTabSelect': function (tabid)
			{
				return manuallyCheckChanges();
			},
			'onTabSelect': function (tabid)
			{
				$.CswCookie('set', CswCookieName.CurrentTabId, tabid);
			},
			'onPropertyChange': function (propid, propname)
			{
				//if(debug) log('Property Changed: propid = ' + propid + ', propname = ' + propname);
				setChanged();
            },
            'onEditView': function (viewid)
            {
                clear({ 'all': true });
                $('#CenterTopDiv').CswViewEditor({
                	'viewid': viewid,
					'viewmode': 'Grid',
                    'onCancel': function ()
                    {
                        clear({ 'all': true });
                        refreshSelected();
                    },
                    'onFinish': function (viewid, viewmode)
                    {
                        // ignore incoming viewid and viewmode, restore previous instead
						clear({ 'all': true });
						refreshSelected();
					},
                    'startingStep': 2
                });
            },
			'ShowCheckboxes': multi,
			'NodeCheckTreeId': MainTreeId
		});
	}

	function refreshSelected(options)
	{
		if (debug) log('NewMain.refreshSelected()');

		if (manuallyCheckChanges())
		{
			var o = {
				nodeid: '',
				cswnbtnodekey: '',
				nodename: '',
				iconurl: '',
                viewid: '',
                viewmode: 'tree',
                showempty: false,
                forsearch: false,
				IncludeNodeRequired: false
			};
			if (options) $.extend(o, options);
			
			switch (o.viewmode)
			{
				case 'grid':
					{
						getViewGrid({
                            'viewid': o.viewid,
			                'nodeid': o.nodeid,
			                'cswnbtnodekey': o.cswnbtnodekey,
                            'showempty': o.showempty,
                            'forsearch': o.forsearch
                        });
						break;
					}
				default: //tree
					{
						refreshNodesTree({
							'nodeid': o.nodeid,
							'cswnbtnodekey': o.cswnbtnodekey,
							'nodename': o.nodename,
                            'viewid': o.viewid,
                            'viewmode': o.viewmode,
                            'showempty': o.showempty,
                            'forsearch': o.forsearch,
                            'IncludeNodeRequired': o.IncludeNodeRequired
						});
						break;
					}
			} // switch
		} // if (manuallyCheckChanges())
	} // refreshSelected()

	var multi = false;

	function refreshNodesTree(options)
	{
		if (debug) log('NewMain.refreshNodesTree()');

		var o = {
			'nodeid': '',
			'cswnbtnodekey': '',
			'nodename': '',
            'showempty': false,
			'forsearch': false,
			'iconurl': '',
			'viewid': '',
			'viewmode': 'tree',
			'IncludeNodeRequired': false
		};		
		if (options) $.extend(o, options);

		var getEmptyTree = (isTrue(o.showempty));
		if (isNullOrEmpty(o.nodeid))
			o.nodeid = $.CswCookie('get', CswCookieName.CurrentNodeId);
		if (isNullOrEmpty(o.cswnbtnodekey))
			o.cswnbtnodekey = $.CswCookie('get', CswCookieName.CurrentNodeKey);
		if (isNullOrEmpty(o.viewid))
			o.viewid = $.CswCookie('get', CswCookieName.CurrentViewId);

		clear({ left: true });

		$('#LeftDiv').CswNodeTree('init', { 'ID': MainTreeId,
											'viewid': o.viewid,
											'viewmode': o.viewmode,
											'nodeid': o.nodeid, 
											'cswnbtnodekey': o.cswnbtnodekey,
											'nodename': o.nodename,
											'showempty': getEmptyTree,
                                            'forsearch': o.forsearch,
											'IncludeNodeRequired': o.IncludeNodeRequired,
											'onViewChange': function (newviewid)
												{
													$.CswCookie('set', CswCookieName.CurrentViewId, newviewid);
												},
											'onSelectNode': function (optSelect)
												{
										   			onSelectTreeNode({
																		'viewid': optSelect.viewid,
																		'nodeid': optSelect.nodeid,
																		'cswnbtnodekey': optSelect.cswnbtnodekey
																	});
												},
											'ShowCheckboxes': multi
										}); // CswNodesTree
	} // refreshNodesTree()

</script>

<!--#include file="NewFooter.html" -->
