<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--#include file="NewHeader.html" -->

					<tr>
						<td id="Td5" class="PageTable_LeftColumn" rowspan="5">
							<img src="Images/pagelayout/blank.gif" alt="X" width="1" height="450"/>
						</td>

						<td id="HeaderTable_BottomMenu" class="HeaderTable_BottomMenu" colspan="2">
							<table cellpadding="0" cellspacing="0">
								<tr>
									<td><img id="headerblank4" src="Images/pagelayout/blank.gif" alt="X" width="1" height="30"/></td>
									<td><div id="MainMenuDiv"></div></td>
								</tr>
							</table>
						</td>

						<td id="Td7" class="PageTable_RightColumn" rowspan="5"></td>
					</tr>

					<tr>
						<td colspan="2">
							<div id="ErrorDiv" class="ErrorContent" style="display: none;"></div>
						</td>
					</tr>
		  
					<tr>
						<td id="Td2" class="PageTable_LeftCell" valign="top">
							<div id="ViewSelectDiv"></div>
							<div id="LeftDiv"></div>
						</td>
						<td id="Td3" class="PageTable_RightCell" valign="top" style="padding-left: 5px;">
							<div id="RightDiv"></div>
						</td>
					</tr>
										  
					<tr>
						<td id="Td6" class="PageTable_CenterCell" colspan="2" valign="top">
							<div id="CenterDiv"></div>
						</td>
					</tr>
					
					<tr>
						<td id="Td8" class="PageTable_CenterCell" colspan="2" valign="top">
							<div id="QuickLaunch"></div>
						</td>
					</tr>


<script type="text/javascript">

	var debug = false;

	initAll();

	var MainTreeId = 'main';
	var MainGridId = 'CswNodeGrid';

	function initAll()
	{
		if (debug) log('NewMain.initAll()');

		$('#CenterDiv').CswLogin('login', {
			'onAuthenticate': function (u)
			{
				var view = {
					'viewid': $.CswCookie('get', CswCookieName.CurrentView.ViewId),
					'viewmode': $.CswCookie('get', CswCookieName.CurrentView.ViewMode)
				};
				$('#header_username').text(u);
				$('#header_dashboard').CswDashboard({
					'onSuccess': function ()
					{
						$('#header_menu').CswMenuHeader({
							'onLogout': function ()
							{
								$('#CenterDiv').CswLogin('logout', {
									onDeauthenticate: function ()
									{
										$.CswCookie('clearAll');
										window.location = 'NewMain.html';
									}
								});
							},
							'onSuccess': function ()
							{
								$('#ViewSelectDiv').CswViewSelect({
									'ID': 'mainviewselect',
									'onSelect': handleItemSelect,
									'onSuccess': function ()
									{

										$('#QuickLaunch').CswQuickLaunch({
											'onLinkClick': handleItemSelect,
											'onSuccess': function ()
											{
												if (view.viewid == null)
												{
													refreshWelcome();
												} else
												{
													handleItemSelect({ 'viewid': view.viewid, viewmode: view.viewmode });
												}
											} // onSuccess
										}); // CswQuickLaunch
									}  // onSuccess
								}); // CswViewSelect
							} // onSuccess
						}); // CswMenuHeader
					} // onSuccess
				}); // CswDashboard
			} // onAuthenticate
		}); // CswLogin
	} // initAll()

	function clear(options)
	{
		if (debug) log('NewMain.clear()');

		var o = {
			left: false, 
			right: false, 
			center: false,
			all: false
		};
		if(options) {
			$.extend(o,options);
		}

		if (o.all || o.left)
		{
			$('#LeftDiv').empty();
		}
		if (o.all || o.right)
		{
			$('#RightDiv').empty();
		}
		if (o.all || o.center)
		{
			$('#CenterDiv').empty();
		}
		if (o.all)
		{
			$('#MainMenuDiv').empty();
		}
	}

	function refreshWelcome()
	{
		if (debug) log('NewMain.refreshWelcome()');

		clear({ all: true });
		$('#CenterDiv').CswWelcome('initTable', {
			'onLinkClick': handleItemSelect,
			'onAddClick': function (nodetypeid)
			{
				$.CswDialog('AddNodeDialog', {
					'nodetypeid': nodetypeid,
					'onAddNode': function (nodeid, cswnbtnodekey)
					{
						clear({ all: true });
						refreshNodesTree({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey });
					}
				});
			},
			'onAddComponent': refreshWelcome
		});
	} // refreshWelcome()

	function handleItemSelect(options)
	{
		if (debug) log('NewMain.handleItemSelect()');

		if (manuallyCheckChanges())
		{
			clear({ all: true });
			var o = {
				type: 'view',
				viewmode: 'tree',
				itemid: '',
				text: '',
				iconurl: '',
				viewid: '',
				actionid: '',
				reportid: '',
				linktype: '',
				nodeid: '',
				cswnbtnodekey: ''
			};
			if (options) $.extend(o, options);

			if (o.viewid != undefined && o.viewid != '') //&& o.viewmode != undefined && o.viewmode != ''
			{
				$.CswCookie('set', CswCookieName.CurrentView.ViewId, o.viewid);
				$.CswCookie('set', CswCookieName.CurrentView.ViewMode, o.viewmode);

				switch (o.viewmode) //webservice converts to lower case
				{
					case 'grid':
						{
							getViewGrid({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
							break;
						}
					case 'list':
						{
							refreshNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode, 'nodeid': '', 'cswnbtnodekey': '' });  //, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
							break;
						}
					case 'tree':
						{
							refreshNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode, 'nodeid': '', 'cswnbtnodekey': '' });  //, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
							break;
						}
					default:
						{
							refreshNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode, 'nodeid': '', 'cswnbtnodekey': '' });  //, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
							break;
						}
				}
			}
			else if (o.type != undefined && o.type != '')
			{
				switch (o.type)
				{
					case 'action':
						{
							alert('Actions are not yet handled!');
							break;
						}
					case 'report':
						{
							alert('Reports are not yet handled!');
							break;
						}
					default:
						{
							alert('Handling for link type ' + o.linktype + ' is not implemented yet.');
							break;
						}
				}
			}
		} // if (manuallyCheckChanges())
	} // handleItemSelect()

	function refreshMainMenu(options) 
	{
		if (debug) log('NewMain.refreshMainMenu()');

		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: ''
		};

		if (options)
		{
			$.extend(o, options);
		}

		$('#MainMenuDiv').CswMenuMain({
			'viewid': o.viewid,
			'nodeid': o.nodeid,
			'cswnbtnodekey': o.cswnbtnodekey,
			'onAddNode': function (nodeid, cswnbtnodekey)
			{
				refreshSelected({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey });
			},
			'onMultiEdit': function ()
			{
				multi = !multi;
				refreshSelected({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
			},
			'onEditView': function (viewid)
			{
				clear({ 'all': true });
				$('#CenterDiv').CswViewEditor('init');
			},
			'Multi': multi,
			'NodeCheckTreeId': MainTreeId
		});
	}

	function getViewGrid(options)
	{
		if (debug) log('NewMain.getViewGrid()');

		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: '',
            onAddNode: '',
            onEditNode: '',
            onDeleteNode: ''
		};
		if (options)
		{
			$.extend(o, options);
		}

		o.onAddNode = function (nodeid, cswnbtnodekey)
			{
				var ocopy = o;
				var x = { 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey };
				$.extend(ocopy, x);
				getViewGrid(ocopy);
			};
        o.onEditNode = function() { getViewGrid(o); };
        o.onDeleteNode = function() { getViewGrid(o); };

		$('#CenterDiv').CswNodeGrid({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 'id': MainGridId });
        refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
	}

	function onSelectTreeNode(options)
	{
		if (debug) log('NewMain.onSelectTreeNode()');

		if (manuallyCheckChanges())
		{
			var o = {
				viewid: '',
				nodeid: '',
				nodename: '',
				iconurl: '',
				cswnbtnodekey: ''
			};
			if (options)
			{
				$.extend(o, options);
			}

			$.CswCookie('set', CswCookieName.CurrentNode.NodeId, o.nodeid);
			$.CswCookie('set', CswCookieName.CurrentNode.NodeKey, o.cswnbtnodekey);

			if (o.nodeid != '' && o.nodeid != 'root')
			{
				getTabs({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
				refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
			} 
			else
			{
				clear({ 'right': true });
			}
		}
	} // onSelectTreeNode()

	function getTabs(options)
	{
		if (debug) log('NewMain.getTabs()');

		var o = {
			nodeid: '',
			cswnbtnodekey: ''
		};
		if (options)
		{
			$.extend(o, options);
		}

		clear({ right: true });
		$('#RightDiv').CswNodeTabs({
			'ID': 'nodetabs',
			'nodeid': o.nodeid,
			'cswnbtnodekey': o.cswnbtnodekey,
			'onSave': function (nodeid, cswnbtnodekey)
			{
				unsetChanged();
				refreshSelected({ 'nodeid': nodeid, 'cswnbtnodekey': cswnbtnodekey });
			},
			'tabid': $.CswCookie('get', CswCookieName.CurrentTabId),
			'onBeforeTabSelect': function (tabid)
			{
				return manuallyCheckChanges();
			},
			'onTabSelect': function (tabid)
			{
				$.CswCookie('set', CswCookieName.CurrentTabId, tabid);
			},
			'onPropertyChange': function (propid, propname)
			{
				//if(debug) log('Property Changed: propid = ' + propid + ', propname = ' + propname);
				setChanged();
			},
			'ShowCheckboxes': multi,
			'NodeCheckTreeId': MainTreeId
		});
	}

	function refreshSelected(options)
	{
		if (debug) log('NewMain.refreshSelected()');

		if (manuallyCheckChanges())
		{
			var o = {
				type: 'tree',
				nodeid: '',
				cswnbtnodekey: '',
				nodename: '',
				iconurl: ''
			};
			if (options) $.extend(o, options);
	
			switch (o.type)
			{
				case 'grid':
					{
						alert('Grid not implemented yet!');
						break;
					}
				case 'list':
					{
						alert('List not implemented yet!');
						break;
					}
				default: //tree
					{
						refreshNodesTree({
							'nodeid': o.nodeid,
							'cswnbtnodekey': o.cswnbtnodekey,
							'nodename': o.nodename 
						});
						break;
					}
			} // switch
		} // if (manuallyCheckChanges())
	} // refreshSelected()

	var multi = false;

	function refreshNodesTree(options)
	{
		if (debug) log('NewMain.refreshNodesTree()');

		var o = {
			'nodeid': $.CswCookie('get', CswCookieName.CurrentNode.NodeId),
			'cswnbtnodekey': $.CswCookie('get', CswCookieName.CurrentNode.NodeKey),
			'nodename': '', 
			'iconurl': '',
			'viewid': $.CswCookie('get', CswCookieName.CurrentView.ViewId),
			'viewmode': 'tree'
		};		
		if (options) $.extend(o, options);

		clear({ left: true });

		$('#LeftDiv').CswNodeTree('init', { 'ID': MainTreeId,
											'viewid': o.viewid,
											'viewmode': o.viewmode,
											'nodeid': o.nodeid, 
											'cswnbtnodekey': o.cswnbtnodekey,
											'nodename': o.nodename,
											'IncludeNodeRequired': true,
											'onViewChange': function(newviewid)
												{
													$.CswCookie('set', CswCookieName.CurrentView.ViewId, newviewid);
												},
											'onSelectNode': function (optSelect)
												{
										   			onSelectTreeNode({
																		'viewid': optSelect.viewid,
																		'nodeid': optSelect.nodeid,
																		'cswnbtnodekey': optSelect.cswnbtnodekey
																	});
												},
											'ShowCheckboxes': multi
										}); // CswNodesTree
	} // refreshNodesTree()

</script>

<!--#include file="NewFooter.html" -->
