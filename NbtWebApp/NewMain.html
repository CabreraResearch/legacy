<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--#include file="NewHeader.html" -->

					<tr>
						<td id="Td5" class="PageTable_LeftColumn" rowspan="5">
							<img src="Images/pagelayout/blank.gif" alt="X" width="1" height="450"/>
						</td>

						<td id="HeaderTable_BottomMenu" class="HeaderTable_BottomMenu" colspan="2">
							<table cellpadding="0" cellspacing="0">
								<tr>
									<td><img id="headerblank4" src="Images/pagelayout/blank.gif" alt="X" width="1" height="30"/></td>
									<td><div id="MainMenuDiv"></div></td>
								</tr>
							</table>
						</td>

						<td id="Td7" class="PageTable_RightColumn" rowspan="5"></td>
					</tr>

					<tr>
						<td colspan="2">
							<div id="ErrorDiv" class="ErrorContent" style="display: none;"></div>
						</td>
					</tr>
		  
					<tr>
						<td id="Td2" class="PageTable_LeftCell" valign="top">
							<div id="ViewSelectDiv"></div>
							<div id="LeftDiv"></div>
						</td>
						<td id="Td3" class="PageTable_RightCell" valign="top" style="padding-left: 5px;">
							<div id="RightDiv"></div>
						</td>
					</tr>
										  
					<tr>						<td id="Td6" class="PageTable_CenterCell" colspan="2" valign="top">
							<div id="CenterDiv"></div>
						</td>
					</tr>
					
					<tr>
						<td id="Td8" class="PageTable_CenterCell" colspan="2" valign="top">
							<div id="QuickLaunch"></div>
					</td>
					</tr>


<script type="text/javascript">

	var debug = false;
	
	initAll();

	function initAll()
	{
		if (debug) log('NewMain.initAll()');

		$('#CenterDiv').CswLogin('login', {
			'onAuthenticate': function (u)
			{
				var view = GetCurrentView();
				$('#header_username').text(u);
				$('#header_dashboard').CswDashboard({ 
					'onSuccess': function() 
						{ 
							$('#header_menu').CswMenuHeader({ 
								'onLogout': function ()
									{
										$('#CenterDiv').CswLogin('logout', {
											onDeauthenticate: function ()
											{
												window.location = 'NewMain.html';
											}
										});
									},
								'onSuccess': function ()
									{
										$('#ViewSelectDiv').CswViewSelect({ 
											'ID': 'mainviewselect', 
											'onSelect': handleItemSelect, 
											'onSuccess': function() { 

												$('#QuickLaunch').CswQuickLaunch({ 
													'onLinkClick': handleItemSelect,
													'onSuccess': function()
														{
															if (view.viewid == null)
															{
																refreshWelcome();
															} else
															{
																handleItemSelect({ 'viewid': view.viewid, viewmode: view.viewmode });
																//getNodesTree( {'viewid': view.viewid} );
															}
														} // onSuccess
												}); // CswQuickLaunch
											}  // onSuccess
										}); // CswViewSelect
									} // onSuccess
							}); // CswMenuHeader
						} // onSuccess
				}); // CswDashboard
			} // onAuthenticate
		});  // CswLogin
	} // initAll()

	function clear(options)
	{
		var o = {
			left: false, 
			right: false, 
			center: false,
			all: false
		};
		if(options) {
			$.extend(o,options);
		}

		if (debug)
		{
			log('NewMain.clear()');
			log(o);
		}

		if (o.all || o.left)
		{
			$('#LeftDiv').contents().remove();
		}
		if (o.all || o.right)
		{
			$('#RightDiv').contents().remove();
		}
		if (o.all || o.center)
		{
			$('#CenterDiv').contents().remove();
		}
	}

	function refreshWelcome()
	{
		clear({ all: true });
		$('#CenterDiv').CswWelcome('initTable', {
			'onLinkClick': handleItemSelect,
			'onAddClick': function (nodetypeid)
			{
				$.CswDialog('AddNodeDialog', {
					'nodetypeid': nodetypeid,
					'onAddNode': function (nodeid)
					{
						clear({ all: true });
						getNodesTree({ 'nodeid': nodeid });
					}
				});
			},
			'onAddComponent': refreshWelcome
		});
	} // refreshWelcome()

	function handleItemSelect(options) 
	{
		clear({ all: true });
		var o = {
					type: 'view',
					viewmode: 'tree',
					itemid: '', 
					text: '', 
					iconurl: '',
					viewid: '',
					actionid: '',
					reportid: '',
					linktype: '',
					cswnbtnodekey: ''
				 };
		if (options) {
			$.extend(o, options);
		}
		
		SetCurrentView({ viewid: o.viewid, viewmode: o.viewmode });

		if (o.viewid != undefined && o.viewid != '') //&& o.viewmode != undefined && o.viewmode != ''
		{
		    switch(o.viewmode) //webservice converts to lower case
		    {
			    case 'grid':
			    {
				    if (debug) log('handleItemSelect() called getViewGrid()');
                    getViewGrid( { 'viewid': o.viewid, 'nodeid': '', 'cswnbtnodekey': o.cswnbtnodekey } );
				    break;
			    }
			    case 'list':
			    {
			        if (debug) log('handleItemSelect() called getNodesTree() for ' + o.viewmode);
			        getNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode });
				    break;
			    }
			    case 'tree': 
			    {
                    if(debug) log('handleItemSelect() called getNodesTree() for ' + o.viewmode);
                    getNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode });
				    break;
			    }
                default:
                {
                    if (debug) log('handleItemSelect() called getNodesTree() for ' + o.viewmode);
                    getNodesTree({ 'viewid': o.viewid, 'viewmode': o.viewmode });
                    break;
                }
            }
        }
		else if(o.type != undefined && o.type != '')
		{
			switch(o.type)
			{
				case 'action':
				{
					alert('Actions are not yet handled!');
					break;
				}
				case 'report':
				{
					alert('Reports are not yet handled!');
					break;
				}
				default:
				{
					alert('Handling for link type ' + o.linktype + ' is not implemented yet.');
					break;
				}
			}
		}
	}
	
	function refreshMainMenu(options) {
		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: ''
		};

		if (options)
		{
			$.extend(o, options);
		}

		if (debug) log('NewMain.refreshMainMenu()');
		if (debug) log(o);

		$('#MainMenuDiv').CswMenuMain( {'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 'onAddNode': refreshSelected} );
	}

	function getViewGrid(options)
	{
		var o = {
			viewid: '',
			nodeid: '',
			cswnbtnodekey: '',
			id: 'CswNodeGrid',
            onAddNode: '',
            onEditNode: '',
            onDeleteNode: ''
		};
		if (options)
		{
			$.extend(o, options);
		}

		o.onAddNode = function() { getViewGrid(o); };
        o.onEditNode = function() { getViewGrid(o); };
        o.onDeleteNode = function() { getViewGrid(o); };

		if (debug)
		{
			log('NewMain.getViewGrid()');
			log(o);
		}
		
		$('#CenterDiv').CswNodeGrid({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 'id': o.id });
	}

	function getNodesTree(options) {
		var o = {
			'ID': 'main',
		    'viewid': '',
            'viewmode': 'tree',
			'nodeid': ''
		};

		if (options) {
			$.extend(o, options);
		}

		if (debug) 
		{
			log('NewMain.getNodesTree() on ' + o.viewmode + ' view');
		}

		$('#LeftDiv').CswNodeTree('init', {
											'ID': o.ID, 
											'viewid': o.viewid,
											'viewmode': o.viewmode, 
											'nodeid': o.nodeid,
											'onSelectNode': function(optSelect) { 
													onSelectTreeNode({ 'viewid': optSelect.viewid,
																		'nodeid': optSelect.id,
																		'cswnbtnodekey': optSelect.cswnbtnodekey
																	});
												}
										});
	}

	function onSelectTreeNode(options) {
		var o = {
			viewid: '', 
			nodeid: '', 
			cswnbtnodekey: ''
		};
		if (options)
		{
			$.extend(o, options);
		}

		if (debug)
		{
			log('NewMain.onSelectTreeNode()');
		}

		getTabs( {'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey} );
		refreshMainMenu({ 'viewid': o.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey });
	}

	function getTabs(options)
	{
		var o = {
			nodeid: '',
			cswnbtnodekey: '',
			onSave: refreshSelected
		};
		if (options)
		{
			$.extend(o, options);
		}

		if (debug)
		{
			log('NewMain.getTabs()');
			//log(o);
		}

		clear({ right: true });
		$('#RightDiv').CswNodeTabs({ 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 'onSave': o.onSave });
	}

	function refreshSelected(options)
	{
		var o = {
			type: 'tree',
			nodeid: '',
			cswnbtnodekey: '',
			'ID': 'main',
			nodename: '', 
			iconurl: ''
		};
		if(options) $.extend(o,options);
		
		switch (o.type)
		{
			case 'grid':
			{
				alert('Grid not implemented yet!');
				break;
			}
			case 'list':
			{
				alert('List not implemented yet!');
				break;
			}
			default: //tree
			{
				refreshNodesTree({ 'ID': o.ID, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 'nodename': o.nodename });
				break;
			}
		}

	}

	function refreshNodesTree(options)
	{
		var view = GetCurrentView();

		var o = {
			'ID': 'main',
			nodeid: '',
			cswnbtnodekey: '',
			nodename: '', 
			iconurl: ''
		};
		var onSelectNode = function (opt) { //nodeid, nodename, iconurl, cswnbtnodekey
			   onSelectTreeNode(opt); } //viewid, nodeid, cswnbtnodekey
		
		if (options)
		{
			$.extend(o, options);
		}

		if (debug)
		{
			log('NewMain.refreshNodesTree()');
			//log(o);
		}

		clear({ left: true });
		$('#LeftDiv').CswNodeTree('init', {'ID': o.ID, 'viewid': view.viewid, 'nodeid': o.nodeid, 'cswnbtnodekey': o.cswnbtnodekey, 
										   'nodename': o.nodename, 
										   'onSelectNode': function(optSelect) { 
													onSelectTreeNode({ 'viewid': optSelect.viewid,
																		'nodeid': optSelect.id,
																		'cswnbtnodekey': optSelect.cswnbtnodekey
																	});
												}
										});
	}

</script>

<!--#include file="NewFooter.html" -->
