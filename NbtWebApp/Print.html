<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="shortcut icon" href="images/favicon.ico" />
    <title>ChemSW Live</title>
    <!--#include file="MainIncludes.html" -->
    <!--#include file="MainCswIncludes.html" -->
    <script type="text/javascript">

        window.onload = Csw.method(function () {
            var cswPublic = {};
            var cswPrivate = {
                name: 'print_label',
                nodeid: '',
                propid: '',
                parent: Csw.literals.factory($('#divBody'), cswPublic),
                stopSpinner: function () {
                    $('#spinner').hide();
                },
                startSpinner: function () {
                    $('#spinner').show();
                },
                doPrint: '',
                jZeb: {},
                labelData: [],
                controlType: 'jZebra'
            };

            Csw.subscribe(Csw.enums.events.ajax.globalAjaxStop, cswPrivate.stopSpinner);
            Csw.subscribe(Csw.enums.events.ajax.globalAjaxStart, cswPrivate.startSpinner);

            cswPrivate.table = cswPublic.table();
            cswPrivate.queryString = Csw.queryString();
            cswPrivate.processingDiv = Csw.literals.factory($('#processing'));

            cswPrivate.doPrint = function () {
                var processingNow = cswPrivate.processingDiv.div();
                var processingCnt = 0;
                var processingTtl = cswPrivate.labelData.length;
                Csw.each(cswPrivate.labelData, function (label, idx) {
                    processingCnt += 1;
                    //processingNow.empty();
                    processingNow.span({ text: 'Printing label ' + processingCnt + ' of ' + processingTtl + ' for target ' + label.TargetName + '.' });
                    cswPrivate.jZeb.print(label.EplText);
                });
            };

            Csw.ajaxWcf.get({
                urlMethod: 'Labels/label/' + Csw.string(cswPrivate.queryString.PrintLabelNodeId) + '/target/' + Csw.string(cswPrivate.queryString.TargetId),
                success: Csw.method(function (data) {
                    if (data.Labels) {

                        cswPrivate.labelData = data.Labels;
                        cswPrivate.processingDiv.span({ text: 'Received EPL Text for ' + data.Labels.length + ' label(s).' });

                        try {
                            cswPrivate.jZeb = cswPrivate.table.cell(1, 1).jZebra();
                        } catch (e) {
                            Csw.debug.error(e);
                        }

                        try {
                            cswPrivate.jZeb.findPrinters();
                        } catch (e) {
                            Csw.debug.error(e);
                        }



                        var printBtn = cswPrivate.table.cell(1, 2).buttonExt({
                            icon: Csw.enums.getName(Csw.enums.iconType, Csw.enums.iconType.barcode),
                            size: 'medium',
                            width: '100px',
                            bindOnEnter: true,
                            name: 'print_label_print',
                            enabledText: 'Print',
                            disableOnClick: false,
                            onClick: function () {
                                cswPrivate.doPrint();
                            }
                        });

                        var refresh = Csw.literals.factory($('#footer'));
                        refresh.buttonExt({
                            icon: Csw.enums.getName(Csw.enums.iconType, Csw.enums.iconType.refresh),
                            size: 'small',
                            onClick: function () {
                                window.location.refresh(true);
                            },
                            disableOnClick: false
                        });
                    } else {
                        Csw.error.throwException(Csw.error.exception('No EPL content matched the request print operation.', '', 'Print.html', 81));
                    }
                }),
                error: function (data) {
                }
            }); // ajax

            return cswPublic;

        });
        

        
    </script>
</head>
<body>
    <div id="content">
        <div id="spinner" width="100%" style="text-align: center; display: none;">
            <img src="images/ajax/progress.gif" />
        </div>
        <div id="DialogErrorDiv">
        </div>
        <h4 id="title">
            Select a Raw Text printer and click Print to begin printing.</h4>
        <h5 id="processing">
        </h5>
        <div id="divBody">
        </div>
        <div id="hiddenDiv" style="visibility: hidden; border: 1px solid red;">
            <applet id="jzebra" name="jzebra" code="jzebra.PrintApplet.class" archive="vendor/jZebra/jzebra.jar"
                width="50" height="50"></applet>
        </div>
        <div id="bottom" align="right" stye="text-align: right;">
            <h6 id="footer">
            </h6>
        </div>
    </div>
</body>
</html>
